{% extends 'site.html' %}

{% block title %}Booking{% endblock %}

<!-- 
content_header, flashed messages, and content are in 
<main class="container-fluid mt-4"> 
-->

{% block content_header %}
{% endblock %}

{% block content %}
{# loaderDiv to be displayed until bookedDiv gets populated #}
<div id="loaderDiv" class="pt-5">
  <div class="d-flex row justify-content-center text-center">
    <div class="loader"></div><p class="mt-3 fadeIn">Booking...</p>
  </div>
</div>

{# bookedDiv with the meat of the page: the booking confirmation when done #}
<div id="bookedDiv" class="container-fluid mt-2 mb-4 text-center" style="display:none;">
  <h1 class="gold-shadow">You're booked!</h1>
  <div class="d-flex justify-content-center">
  <div class="card text-center bg-light col-lg-4 col-md-6 col-sm-10">
    <img class="card-img-top" src="{{ url_for('static', filename="images/makeup2.jpg") }}" alt="makeup">
    <div class="card-body">
      <h3 class="card-title">Custom Makeup Session</h3>
      <h4 class="card-title">{{ apptDate }}</h4>
      <h4 class="card-title">{{ apptTime.start }} &ndash; {{ apptTime.end }}</h4>
    </div>
  </div>
  </div>
  {# <!-- *** Reschedule or cancel link(s) ***
  <a class="btn btn-gold" href={{ url_for('site.***') }}>Reschedule</a>
  --> #}
</div>

{# emailDiv will give status of the confirmation email #}
<div id="emailDiv" class="pt-2" style="display:none; color:IndianRed;">
  <p>Sorry, there was an error sending your confirmation email.</p>
  <p>Keep track of this link if you may want to reschedule or cancel your appointment:</p>
</div>


<script type="text/javascript">
  /* Show loader until available sessions can be fetched, then display */
  fetch(`${window.location.origin}/bookAppt`)
    /* .then(response => response.json()) */
    .then(function(response) {
      console.log(response.headers.get('Content-Type'));  /* application/json               */
      console.log(response.headers.get('Date'));          /* Fri, 14 May 2021 15:42:09 GMT  */
      console.log(response.status);                       /* 200                            */
      console.log(response.statusText);                   /* OK                             */
      console.log(response.type);                         /* basic                          */
      console.log(response.url);                          /* http://127.0.0.1:5000/bookAppt */
      return response.json();
    })
    .then(function(data) {
      var bookedDiv = document.getElementById("bookedDiv");
      var loaderDiv = document.getElementById("loaderDiv");

      /* If error, fail gracefully and direct user to contact me page. */
      if ("error" in data) {
        console.log("Error: " + data["error"]);

        bookedDiv.innerHTML = "<p>Sorry, there was an error while creating your appointment.</p>"
        bookedDiv.innerHTML += "<p>Please <a href=\"{{ url_for('site.contact') }}\">contact me</a> to book a session or try again soon.</p>";
        bookedDiv.innerHTML += "<p>Thank you!</p>"
        bookedDiv.style.color = "IndianRed";

        /* let newP = document.createElement("p"); */
        /* newP.appendChild(document.createTextNode("Sorry, there was an error while getting the available sessions.")); */
        /* bookedDiv.appendChild(newP); */
      } 

      else if ("emailError" in data) {
        apptID = data['apptID'];
        console.log("apptID:");
        console.log(apptID);
        var emailDiv = document.getElementById("emailDiv");
        let newP = document.createElement("p");
        let newA = document.createElement("a");
        let newT = document.createTextNode("{{ url_for('site.booked') }}/" + apptID);
        newA.setAttribute("href", "{{ url_for('site.booked') }}/" + apptID);
        newA.appendChild(newT);
        newP.appendChild(newA);
        emailDiv.appendChild(newP);
        emailDiv.style.display = "inherit";
      }
     
      else {
        apptID = data['apptID'];
        console.log("apptID:");
        console.log(apptID);
      }

      /* Display the booking confirmation */
      loaderDiv.style.display = "none";
      bookedDiv.style.display = "inherit";
    })
    .catch(error => console.log(error));
</script>
{% endblock %}
